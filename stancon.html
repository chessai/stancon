<!DOCTYPE HTML><html>
<head><meta charset="utf-8"><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" rel="stylesheet"><script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body><div class="container"><div class="row"><div class="col-sm-12">
<h1>Getting more out of Stan: some ideas from the Haskell bindings</h1>
<p>Thomas A Nielsen<sup>1</sup>, Dominic Steinitz<sup>1</sup> and Henrik Nilsson<sup>2</sup></p>
<ol>
<li>Tweag I/O</li>
<li>School of Computer Science, University of Nottingham</li>
</ol>
<h2>Introduction</h2>
<p>Probabilistic programming is one of the most promising developments in statistical computing in recent times.
By combining programming languages theory with statistical modelling, it empowers modellers with a flexible
framework for statistical computing in which a great variety of models can be expressed using composition of
arbitrary probability distributions within flexible control flow to express dependencies and data structures known
to, or hypothesised by, the modeller.</p>
<p>Probabilistic programming is distinguished from stochastic programming by the capability to condition the random
variables on observed data; essentially to perform the Bayesian update and move from prior to posterior
distributions. Sometimes the posterior suffices. For instance, a causal link may be predicated on a certain regression
coefficient being non-zero. Nevertheless, probabilistic programming in its full power is not restricted only to calculating
the posterior. Computations based on this posterior may be more directly relevant to the data analyst or to the
decision maker and often require further probabilistic calculations. For instance:</p>
<ul>
<li>predicting outcomes based on new observations</li>
<li>model criticism based on residuals or the posterior predictive distribution</li>
<li>forecasting timeseries</li>
<li>risk analysis</li>
<li>decision-making</li>
<li>resource allocation</li>
</ul>
<p>Stan has emerged as the most practical and widely used probabilistic programming language for Bayesian computation.
In its canonical form, Stan only calculates the posterior and leaves all further analysis to generic programming
languages. Some further calculations can be done within Stan alone, but these are quite limited and tricky to apply. Most
often, post-posterior calculations are deferred to the host programming language such as Python or R. For
instance, to calculate residuals or to make predictions in a predictive model, one must write the model twice:
once in the Stan modelling language, for inference, and once in the host language, for simulation and prediction.
This has the disadvantage that the two models may become out of sync and some
probability distributions may be parameterised in different ways. This is not much work for simple models, such as
linear regression model; the reader may feel that the author doth protest too much. But for more complex models
it may not at all be obvious how to transfer the posterior into a simulation environment.</p>
<p>Here, we present the results of some experiments with creating <a href="https://github.com/diffusionkinetics/open/tree/master/stanhs">bindings to Stan in Haskell</a>,
a purely functional
and statically typed programming language. Rather than present “yet another Stan binding” or even worse, try to
persuade the reader to abandon their current programming language and learn Haskell, our aim here is to present
some ideas enable a richer set of probabilistic computations from Stan models. This obviates the need
to also implement the model in the host language, thus addressing the
above problem with existing bindings. Our ideas are general and could,
in principle, be leveraged to improve existing interfaces to Stan.
Nevertheless, we have chosen here to explore these ideas in Haskell
due to its support for embedded languages, ease of re-factoring experimental code, and its emerging data science
ecosystem.</p>
<h2>The Haskell programming language</h2>
<p>Haskell is a pure, statically typed, general purpose functional
language with lazy evaluation. It is widely used in academia for
teaching and research, and increasingly for commercial software
development as Haskell is conducive to rapid development of reliable
code. Purity means that functions have no side effects, except where
explicitly reflected in the function type, and then only those effects
that are permitted by the type in question. This enforced effect
discipline, in combination with an expressive type system, make it a
lot easier to understand and maintain code, especially when it grows
large. Purity implies that equational reasoning is valid, making
Haskell a particularly good fit for mathematical applications. Lazy
evaluation means that computation is demand driven. This, to a large
extent, frees the programmer from operational concerns, allowing them
to focus on stating what to compute rather than how to do it, which is
another reason for why Haskell is a good fit for mathematical
applications.</p>
<p>One area where Haskell has proved particularly successful is as a host
language for domain-specific languages. There are a number of reasons
for this. One is Haskell&#39;s concise yet flexible syntax with extensive
support for overloading of operators and other notation through type
classes. Another is that all values in Haskell, including functions,
are first-class; i.e., they can be bound to variables, passed to and
returned from functions, and so on, greatly facilitating implementing
appropriate domain-specific abstractions. Haskell is also particularly
well suited for symbolic computations, such as what is needed for
compiler applications. In the setting of embedded domain-specific
languages, this allows for a spectrum of implementation strategies,
from interpretation to compilation, as well as programmatic
construction of programs in the domain-specific language, often
referred to as metaprogramming or metamodelling
(Augustsson et al, 2008; Giorgidze and Nilsson, 2011; Svenningsson and Axelsson, 2013).
Finally, thanks to its powerful type
system, it is often possible to enforce domain-specific typing
constraints (Thiemann, 2002).
We will see some of these features being put to good use
in the following.</p>
<p>For a data scientist or statistician, the Haskell language holds
several attractions. Most importantly, Haskell now has an ecosystem
and a community for data science and numerical computing that is, if
not best in class, then increasingly productive with many packages
implementing different methods, in particular for a general purpose
programming language that was not designed with numerical computing in
mind. On a spectrum of data science needs, Haskell is particularly
suited to productizing models that have been developed in languages or
environments that may be more suited for exploratory data analysis.
The <a href="https://tweag.github.io/HaskellR/">inline-r</a> project, for instance, gives Haskell programmers direct
access to all of the R programming language, facilitating moving data
science into a production environment. Haskell’s type system makes it
very simple to re-factor large code bases which may blur the boundary
between data science and software engineering.</p>
<h2>Bayesian modelling in Haskell and Stan</h2>
<p>Unlike in other Stan interfaces, in our prototype interface the Stan
model itself is described in a data structure in the host language,
here in Haskell. This has the disadvantage that the Stan file has
slightly more syntactic noise and is less familiar. However, the Stan
model description is now a value in a programming language that can be
manipulated and calculated based on the circumstances, a form of
metamodelling as discussed in the previous section. There are also
other advantages that will become apparent later in this paper.
Moreover, there are a number of ways in Haskell to reduce the
syntactic noise by making the model look more like plain Stan code
should that be desired in a more mature implementation; e.g.
quasiquoting (Mainland, 2007).</p>
<p>In our current implementation, the Stan model value looks like this:</p>
<pre class="haskell"><code>linRegression :: [Stan]
linRegression = [
  Data [ lower 0 Int ::: &quot;n&quot;
       , lower 0 Int ::: &quot;p&quot;
       , Real ::: &quot;y&quot;![&quot;n&quot;]
       , Real ::: &quot;x&quot;![&quot;n&quot;,&quot;p&quot;]
       ],
  Parameters [
       Real ::: &quot;beta&quot;![&quot;p&quot;],
       Real ::: &quot;sigma&quot;
       ],
  Model [
          For &quot;i&quot; 1 &quot;p&quot; [&quot;beta&quot;![&quot;i&quot;] :~ normal (0.0,1.0)]
          ,&quot;sigma&quot; :~ gamma (1.0,1.0)
          ,For &quot;i&quot; 1 &quot;n&quot; [
            &quot;y&quot;![&quot;i&quot;] :~ normal ((&quot;x&quot;![&quot;i&quot;] `dot` &quot;beta&quot;), &quot;sigma&quot;)
          ]
        ]
  ]
</code></pre>
<p>We can easily see what Stan is generated by pretty-printing the data structure / program we just created:</p>
<pre class="haskell"><code>ppStans linRegression => 
data {
  int<lower=0> n;
  int<lower=0> p;
  real y[n];
  real x[n,p];
}
parameters {
  real beta[p];
  real sigma;
}
model {
  for (i in 1:p) {
    beta[i] ~ normal(0.0,1.0);
  };
  sigma ~ gamma(1.0,1.0);
  for (i in 1:n) {
    y[i] ~ normal(dot_product(x[i],beta),sigma);
  };
}
</code></pre>
<p>We then have to create the data structure holding the input to Stan.
Here, as an example, we will use the Boston Housing dataset from the
<a href="http://hackage.haskell.org/package/datasets">datasets</a> Haskell package. We load this into the <code>bh</code> variable which
will hold a list of records describing Boston housing data (<code>bh ::
[BostonHousing]</code>)</p>
<pre class="haskell"><code>bh &lt;- getDataset bostonHousing
</code></pre>
<p>Here, we plot the median value against the number of rooms in a residence:</p>
<div id="bh"></div><script>Plotly.newPlot('bh', [{"mode":"markers","x":[6.575,6.421,7.185,6.998,7.147,6.43,6.012,6.172,5.631,6.004,6.377,6.009,5.889,5.949,6.096,5.834,5.935,5.99,5.456,5.727,5.57,5.965,6.142,5.813,5.924,5.599,5.813,6.047,6.495,6.674,5.713,6.072,5.95,5.701,6.096,5.933,5.841,5.85,5.966,6.595,7.024,6.77,6.169,6.211,6.069,5.682,5.786,6.03,5.399,5.602,5.963,6.115,6.511,5.998,5.888,7.249,6.383,6.816,6.145,5.927,5.741,5.966,6.456,6.762,7.104,6.29,5.787,5.878,5.594,5.885,6.417,5.961,6.065,6.245,6.273,6.286,6.279,6.14,6.232,5.874,6.727,6.619,6.302,6.167,6.389,6.63,6.015,6.121,7.007,7.079,6.417,6.405,6.442,6.211,6.249,6.625,6.163,8.069,7.82,7.416,6.727,6.781,6.405,6.137,6.167,5.851,5.836,6.127,6.474,6.229,6.195,6.715,5.913,6.092,6.254,5.928,6.176,6.021,5.872,5.731,5.87,6.004,5.961,5.856,5.879,5.986,5.613,5.693,6.431,5.637,6.458,6.326,6.372,5.822,5.757,6.335,5.942,6.454,5.857,6.151,6.174,5.019,5.403,5.468,4.903,6.13,5.628,4.926,5.186,5.597,6.122,5.404,5.012,5.709,6.129,6.152,5.272,6.943,6.066,6.51,6.25,7.489,7.802,8.375,5.854,6.101,7.929,5.877,6.319,6.402,5.875,5.88,5.572,6.416,5.859,6.546,6.02,6.315,6.86,6.98,7.765,6.144,7.155,6.563,5.604,6.153,7.831,6.782,6.556,7.185,6.951,6.739,7.178,6.8,6.604,7.875,7.287,7.107,7.274,6.975,7.135,6.162,7.61,7.853,8.034,5.891,6.326,5.783,6.064,5.344,5.96,5.404,5.807,6.375,5.412,6.182,5.888,6.642,5.951,6.373,6.951,6.164,6.879,6.618,8.266,8.725,8.04,7.163,7.686,6.552,5.981,7.412,8.337,8.247,6.726,6.086,6.631,7.358,6.481,6.606,6.897,6.095,6.358,6.393,5.593,5.605,6.108,6.226,6.433,6.718,6.487,6.438,6.957,8.259,6.108,5.876,7.454,8.704,7.333,6.842,7.203,7.52,8.398,7.327,7.206,5.56,7.014,8.297,7.47,5.92,5.856,6.24,6.538,7.691,6.758,6.854,7.267,6.826,6.482,6.812,7.82,6.968,7.645,7.923,7.088,6.453,6.23,6.209,6.315,6.565,6.861,7.148,6.63,6.127,6.009,6.678,6.549,5.79,6.345,7.041,6.871,6.59,6.495,6.982,7.236,6.616,7.42,6.849,6.635,5.972,4.973,6.122,6.023,6.266,6.567,5.705,5.914,5.782,6.382,6.113,6.426,6.376,6.041,5.708,6.415,6.431,6.312,6.083,5.868,6.333,6.144,5.706,6.031,6.316,6.31,6.037,5.869,5.895,6.059,5.985,5.968,7.241,6.54,6.696,6.874,6.014,5.898,6.516,6.635,6.939,6.49,6.579,5.884,6.728,5.663,5.936,6.212,6.395,6.127,6.112,6.398,6.251,5.362,5.803,8.78,3.561,4.963,3.863,4.97,6.683,7.016,6.216,5.875,4.906,4.138,7.313,6.649,6.794,6.38,6.223,6.968,6.545,5.536,5.52,4.368,5.277,4.652,5,4.88,5.39,5.713,6.051,5.036,6.193,5.887,6.471,6.405,5.747,5.453,5.852,5.987,6.343,6.404,5.349,5.531,5.683,4.138,5.608,5.617,6.852,5.757,6.657,4.628,5.155,4.519,6.434,6.782,5.304,5.957,6.824,6.411,6.006,5.648,6.103,5.565,5.896,5.837,6.202,6.193,6.38,6.348,6.833,6.425,6.436,6.208,6.629,6.461,6.152,5.935,5.627,5.818,6.406,6.219,6.485,5.854,6.459,6.341,6.251,6.185,6.417,6.749,6.655,6.297,7.393,6.728,6.525,5.976,5.936,6.301,6.081,6.701,6.376,6.317,6.513,6.209,5.759,5.952,6.003,5.926,5.713,6.167,6.229,6.437,6.98,5.427,6.162,6.484,5.304,6.185,6.229,6.242,6.75,7.061,5.762,5.871,6.312,6.114,5.905,5.454,5.414,5.093,5.983,5.983,5.707,5.926,5.67,5.39,5.794,6.019,5.569,6.027,6.593,6.12,6.976,6.794,6.03],"type":"scatter","y":[24,21.6,34.7,33.4,36.2,28.7,22.9,27.1,16.5,18.9,15,18.9,21.7,20.4,18.2,19.9,23.1,17.5,20.2,18.2,13.6,19.6,15.2,14.5,15.6,13.9,16.6,14.8,18.4,21,12.7,14.5,13.2,13.1,13.5,18.9,20,21,24.7,30.8,34.9,26.6,25.3,24.7,21.2,19.3,20,16.6,14.4,19.4,19.7,20.5,25,23.4,18.9,35.4,24.7,31.6,23.3,19.6,18.7,16,22.2,25,33,23.5,19.4,22,17.4,20.9,24.2,21.7,22.8,23.4,24.1,21.4,20,20.8,21.2,20.3,28,23.9,24.8,22.9,23.9,26.6,22.5,22.2,23.6,28.7,22.6,22,22.9,25,20.6,28.4,21.4,38.7,43.8,33.2,27.5,26.5,18.6,19.3,20.1,19.5,19.5,20.4,19.8,19.4,21.7,22.8,18.8,18.7,18.5,18.3,21.2,19.2,20.4,19.3,22,20.3,20.5,17.3,18.8,21.4,15.7,16.2,18,14.3,19.2,19.6,23,18.4,15.6,18.1,17.4,17.1,13.3,17.8,14,14.4,13.4,15.6,11.8,13.8,15.6,14.6,17.8,15.4,21.5,19.6,15.3,19.4,17,15.6,13.1,41.3,24.3,23.3,27,50,50,50,22.7,25,50,23.8,23.8,22.3,17.4,19.1,23.1,23.6,22.6,29.4,23.2,24.6,29.9,37.2,39.8,36.2,37.9,32.5,26.4,29.6,50,32,29.8,34.9,37,30.5,36.4,31.1,29.1,50,33.3,30.3,34.6,34.9,32.9,24.1,42.3,48.5,50,22.6,24.4,22.5,24.4,20,21.7,19.3,22.4,28.1,23.7,25,23.3,28.7,21.5,23,26.7,21.7,27.5,30.1,44.8,50,37.6,31.6,46.7,31.5,24.3,31.7,41.7,48.3,29,24,25.1,31.5,23.7,23.3,22,20.1,22.2,23.7,17.6,18.5,24.3,20.5,24.5,26.2,24.4,24.8,29.6,42.8,21.9,20.9,44,50,36,30.1,33.8,43.1,48.8,31,36.5,22.8,30.7,50,43.5,20.7,21.1,25.2,24.4,35.2,32.4,32,33.2,33.1,29.1,35.1,45.4,35.4,46,50,32.2,22,20.1,23.2,22.3,24.8,28.5,37.3,27.9,23.9,21.7,28.6,27.1,20.3,22.5,29,24.8,22,26.4,33.1,36.1,28.4,33.4,28.2,22.8,20.3,16.1,22.1,19.4,21.6,23.8,16.2,17.8,19.8,23.1,21,23.8,23.1,20.4,18.5,25,24.6,23,22.2,19.3,22.6,19.8,17.1,19.4,22.2,20.7,21.1,19.5,18.5,20.6,19,18.7,32.7,16.5,23.9,31.2,17.5,17.2,23.1,24.5,26.6,22.9,24.1,18.6,30.1,18.2,20.6,17.8,21.7,22.7,22.6,25,19.9,20.8,16.8,21.9,27.5,21.9,23.1,50,50,50,50,50,13.8,13.8,15,13.9,13.3,13.1,10.2,10.4,10.9,11.3,12.3,8.8,7.2,10.5,7.4,10.2,11.5,15.1,23.2,9.7,13.8,12.7,13.1,12.5,8.5,5,6.3,5.6,7.2,12.1,8.3,8.5,5,11.9,27.9,17.2,27.5,15,17.2,17.9,16.3,7,7.2,7.5,10.4,8.8,8.4,16.7,14.2,20.8,13.4,11.7,8.3,10.2,10.9,11,9.5,14.5,14.1,16.1,14.3,11.7,13.4,9.6,8.7,8.4,12.8,10.5,17.1,18.4,15.4,10.8,11.8,14.9,12.6,14.1,13,13.4,15.2,16.1,17.8,14.9,14.1,12.7,13.5,14.9,20,16.4,17.7,19.5,20.2,21.4,19.9,19,19.1,19.1,20.1,19.9,19.6,23.2,29.8,13.8,13.3,16.7,12,14.6,21.4,23,23.7,25,21.8,20.6,21.2,19.1,20.6,15.2,7,8.1,13.6,20.1,21.8,24.5,23.1,19.7,18.3,21.2,17.5,16.8,22.4,20.6,23.9,22,11.9]}],{"yaxis":{"title":"Median Value"},"xaxis":{"title":"Rooms"}}, {displayModeBar: false});</script>
<p>To put this into the Stan data format, we create values of the <code>StanEnv</code> type using the custom infix operator <code>&lt;~</code>. Haskell allows library
programmers to define their own infix operators describing the model. Here, we have defined <code>v &lt;~ d</code> to mean, create a Stan environment
where the variable named v holds the data contained in the Haskell variable d. <code>d</code> can be any type for which we have defined how to turn
values into Stan values (that is, implemented the <code>ToStanData</code> type class). We concatenate these elementary Stan environments using the
append operator <code>&lt;&gt;</code>.</p>
<pre class="haskell"><code>let getRow b = [rooms b, crimeRate b]

    sdata = &quot;y&quot; &lt;~ map medianValue bh &lt;&gt;
            &quot;x&quot; &lt;~ map getRow bh &lt;&gt;
            &quot;n&quot; &lt;~ length bh &lt;&gt;
            &quot;p&quot; &lt;~ (2 :: Int)
</code></pre>
<p>Finally, we run the Stan model using the <code>runStan</code> function taking as arguments the model, the data value and a configuration value
that specifies whether we are sampling or optimising the posterior. The resulting posterior will be bound to the variable <code>res</code>.</p>
<pre class="haskell"><code>res &lt;- runStan linRegression sdata sample {numSamples = 500}
</code></pre>
<p>At this point the components of the posterior can be plotted as usual:</p>
<div class=" row "><div class="col-md-4"><div id="beta.1"></div><script>Plotly.newPlot('beta.1', [{"x":[3.70256,3.7080792000000002,3.7135984,3.7191176,3.7246368,3.730156,3.7356752,3.7411944,3.7467136,3.7522328000000003,3.757752,3.7632712,3.7687904,3.7743096,3.7798288,3.785348,3.7908672,3.7963864000000003,3.8019056,3.8074248,3.812944,3.8184632,3.8239824000000002,3.8295016,3.8350208,3.84054,3.8460592,3.8515784,3.8570976,3.8626168,3.8681360000000002,3.8736552,3.8791744,3.8846936,3.8902128,3.895732,3.9012512,3.9067704,3.9122896000000003,3.9178088,3.923328,3.9288472,3.9343664,3.9398856,3.9454048,3.950924,3.9564432,3.9619624,3.9674816,3.9730008,3.97852],"type":"bar","y":[2,0,0,2,1,0,3,6,3,10,9,8,9,11,6,25,16,13,16,18,20,24,21,19,24,16,20,28,16,20,15,16,6,9,15,15,8,6,9,8,5,1,6,4,2,0,3,1,3,1,1]}],{"height":300,"margin":{"l":50,"pad":4,"t":40,"b":30,"r":25},"title":"beta.1"}, {displayModeBar: false});</script></div><div class="col-md-4"><div id="beta.2"></div><script>Plotly.newPlot('beta.2', [{"x":[-0.467903,-0.46309972,-0.45829644,-0.45349316,-0.44868988,-0.4438866,-0.43908332,-0.43428004000000003,-0.42947676,-0.42467348,-0.4198702,-0.41506692,-0.41026364000000004,-0.40546036,-0.40065708,-0.39585380000000003,-0.39105052,-0.38624724,-0.38144396,-0.37664068,-0.3718374,-0.36703412,-0.36223084,-0.35742756,-0.35262428,-0.34782100000000005,-0.34301772,-0.33821444,-0.33341116000000004,-0.32860788,-0.3238046,-0.31900132000000003,-0.31419804,-0.30939476,-0.30459148,-0.2997882,-0.29498492,-0.29018164,-0.28537836,-0.28057508,-0.2757718,-0.27096852000000005,-0.26616524,-0.26136196,-0.25655868000000004,-0.2517554,-0.24695212,-0.24214884,-0.23734556,-0.23254228000000002,-0.22773900000000002],"type":"bar","y":[2,0,0,0,0,1,0,1,5,8,8,8,11,11,19,19,17,26,25,25,30,30,34,22,34,25,25,15,17,12,13,15,7,11,5,6,3,0,4,1,0,3,0,1,0,0,0,0,0,0,1]}],{"height":300,"margin":{"l":50,"pad":4,"t":40,"b":30,"r":25},"title":"beta.2"}, {displayModeBar: false});</script></div><div class="col-md-4"><div id="sigma"></div><script>Plotly.newPlot('sigma', [{"x":[6.42082,6.4435838,6.4663476,6.4891114,6.5118751999999995,6.534639,6.5574028,6.5801666,6.6029304,6.6256942,6.648458,6.6712218,6.6939855999999995,6.7167494,6.7395132,6.762277,6.7850408,6.8078046,6.8305684,6.8533322,6.8760959999999995,6.8988598,6.9216236,6.9443874,6.9671512,6.989915,7.0126788,7.0354426,7.0582063999999995,7.080970199999999,7.103734,7.1264978,7.1492616,7.1720254,7.1947892,7.217553,7.2403167999999996,7.2630806,7.2858444,7.3086082,7.331372,7.3541358,7.3768996,7.3996634,7.4224272,7.4451909999999994,7.467954799999999,7.4907186,7.5134824,7.5362462,7.55901],"type":"bar","y":[2,4,1,1,1,3,11,6,11,11,8,9,12,16,15,14,22,22,16,20,19,24,14,17,17,20,21,20,22,19,9,5,12,9,16,8,8,6,3,7,2,6,1,2,0,3,3,0,1,0,1]}],{"height":300,"margin":{"l":50,"pad":4,"t":40,"b":30,"r":25},"title":"sigma"}, {displayModeBar: false});</script></div></div>
<h2>Simulating From a Stan Model</h2>
<p>In order to obtain a richer probabilistic programming capability based on the Bayesian update in Stan, it suffices to
add a function to simulate from a probabilistic model with fine control over the transfer of information from the posterior to
the simulation environment. By transferring no information, we are simulating from the prior (prior predictive distribution); by transferring
all information, we are simulating from the posterior (posterior predictive distribution). Moreover, by controlling the independent
variables in the dataset we can make predictions for new observations. In the case of timeseries modelling, by manipulating the
starting value we can continue a simulation from the endpoint of observed data (that is, forecast). Crucially, we are proposing
that all of these functions are possible without writing the model twice as is usual: once in Stan, and once in the host language.
Simulation operates on the same model description as that used for inference.</p>
<p>The type of our simulation function is:</p>
<pre class="haskell"><code>runSimulate
  :: Int       -- Number of simulations we would like to perform
  -&gt; [Stan]    -- The Stan model
  -&gt; StanEnv   -- The simulation input environment
  -&gt; [StanEnv] -- A list of independent simulation outputs
</code></pre>
<p>Here <code>runSimulate n m e</code> will perform n independent simulations in the model m using environment e. If m contains values from a
posterior (which has been generated with <code>runStan</code>) then each of the independent simulations will use a consistent set of samples from that posterior.</p>
<p>We quickly demonstrate the concept of simulation by simulating a single replica dataset and plotting it:</p>
<pre class="haskell"><code>seed &lt;- seedEnv &lt;$&gt; newPureMT
let resEnv = seed &lt;&gt; Map.delete &quot;y&quot; sdata &lt;&gt; mcmcToEnv res
    simEnv = runSimulateOnce linRegression resEnv
    postPredOnce = zip (unPairDoubles $ fromJust $ Map.lookup &quot;x&quot; simEnv) (unDoubles $ fromJust $ Map.lookup &quot;y&quot; simEnv)
</code></pre>
<div id="bhpp"></div><script>Plotly.newPlot('bhpp', [{"mode":"markers","x":[6.575,6.421,7.185,6.998,7.147,6.43,6.012,6.172,5.631,6.004,6.377,6.009,5.889,5.949,6.096,5.834,5.935,5.99,5.456,5.727,5.57,5.965,6.142,5.813,5.924,5.599,5.813,6.047,6.495,6.674,5.713,6.072,5.95,5.701,6.096,5.933,5.841,5.85,5.966,6.595,7.024,6.77,6.169,6.211,6.069,5.682,5.786,6.03,5.399,5.602,5.963,6.115,6.511,5.998,5.888,7.249,6.383,6.816,6.145,5.927,5.741,5.966,6.456,6.762,7.104,6.29,5.787,5.878,5.594,5.885,6.417,5.961,6.065,6.245,6.273,6.286,6.279,6.14,6.232,5.874,6.727,6.619,6.302,6.167,6.389,6.63,6.015,6.121,7.007,7.079,6.417,6.405,6.442,6.211,6.249,6.625,6.163,8.069,7.82,7.416,6.727,6.781,6.405,6.137,6.167,5.851,5.836,6.127,6.474,6.229,6.195,6.715,5.913,6.092,6.254,5.928,6.176,6.021,5.872,5.731,5.87,6.004,5.961,5.856,5.879,5.986,5.613,5.693,6.431,5.637,6.458,6.326,6.372,5.822,5.757,6.335,5.942,6.454,5.857,6.151,6.174,5.019,5.403,5.468,4.903,6.13,5.628,4.926,5.186,5.597,6.122,5.404,5.012,5.709,6.129,6.152,5.272,6.943,6.066,6.51,6.25,7.489,7.802,8.375,5.854,6.101,7.929,5.877,6.319,6.402,5.875,5.88,5.572,6.416,5.859,6.546,6.02,6.315,6.86,6.98,7.765,6.144,7.155,6.563,5.604,6.153,7.831,6.782,6.556,7.185,6.951,6.739,7.178,6.8,6.604,7.875,7.287,7.107,7.274,6.975,7.135,6.162,7.61,7.853,8.034,5.891,6.326,5.783,6.064,5.344,5.96,5.404,5.807,6.375,5.412,6.182,5.888,6.642,5.951,6.373,6.951,6.164,6.879,6.618,8.266,8.725,8.04,7.163,7.686,6.552,5.981,7.412,8.337,8.247,6.726,6.086,6.631,7.358,6.481,6.606,6.897,6.095,6.358,6.393,5.593,5.605,6.108,6.226,6.433,6.718,6.487,6.438,6.957,8.259,6.108,5.876,7.454,8.704,7.333,6.842,7.203,7.52,8.398,7.327,7.206,5.56,7.014,8.297,7.47,5.92,5.856,6.24,6.538,7.691,6.758,6.854,7.267,6.826,6.482,6.812,7.82,6.968,7.645,7.923,7.088,6.453,6.23,6.209,6.315,6.565,6.861,7.148,6.63,6.127,6.009,6.678,6.549,5.79,6.345,7.041,6.871,6.59,6.495,6.982,7.236,6.616,7.42,6.849,6.635,5.972,4.973,6.122,6.023,6.266,6.567,5.705,5.914,5.782,6.382,6.113,6.426,6.376,6.041,5.708,6.415,6.431,6.312,6.083,5.868,6.333,6.144,5.706,6.031,6.316,6.31,6.037,5.869,5.895,6.059,5.985,5.968,7.241,6.54,6.696,6.874,6.014,5.898,6.516,6.635,6.939,6.49,6.579,5.884,6.728,5.663,5.936,6.212,6.395,6.127,6.112,6.398,6.251,5.362,5.803,8.78,3.561,4.963,3.863,4.97,6.683,7.016,6.216,5.875,4.906,4.138,7.313,6.649,6.794,6.38,6.223,6.968,6.545,5.536,5.52,4.368,5.277,4.652,5,4.88,5.39,5.713,6.051,5.036,6.193,5.887,6.471,6.405,5.747,5.453,5.852,5.987,6.343,6.404,5.349,5.531,5.683,4.138,5.608,5.617,6.852,5.757,6.657,4.628,5.155,4.519,6.434,6.782,5.304,5.957,6.824,6.411,6.006,5.648,6.103,5.565,5.896,5.837,6.202,6.193,6.38,6.348,6.833,6.425,6.436,6.208,6.629,6.461,6.152,5.935,5.627,5.818,6.406,6.219,6.485,5.854,6.459,6.341,6.251,6.185,6.417,6.749,6.655,6.297,7.393,6.728,6.525,5.976,5.936,6.301,6.081,6.701,6.376,6.317,6.513,6.209,5.759,5.952,6.003,5.926,5.713,6.167,6.229,6.437,6.98,5.427,6.162,6.484,5.304,6.185,6.229,6.242,6.75,7.061,5.762,5.871,6.312,6.114,5.905,5.454,5.414,5.093,5.983,5.983,5.707,5.926,5.67,5.39,5.794,6.019,5.569,6.027,6.593,6.12,6.976,6.794,6.03],"type":"scatter","y":[23.083601062203122,35.386618940510395,14.192489473172722,28.40592647353778,33.47793842194891,22.54532368265548,19.35777119886702,25.43593536898458,14.018354514444319,20.89485695026564,18.100997169711643,9.258890885845288,25.153297477862175,13.679242796433147,25.961947469239966,26.98872311476758,28.273435517434887,14.886333113121873,24.644521075656897,20.609375567674586,17.738344204562306,24.896202028433365,22.025802420534408,21.478730642551636,14.997398198648959,9.359852260070493,20.261296167635,30.57258064182321,15.972924760304679,25.317708205937517,21.519241425888673,12.808541904461636,14.458822800776602,12.018813143908048,23.794035533562845,27.425295148129706,34.24705959619012,35.21768727925614,4.1961257135996135,25.711748098864753,25.83653023770711,26.914458125266332,33.664689030334074,35.752644738227026,31.794504372810508,14.760381230313282,24.927267891032756,28.546561639242785,15.85450260562509,10.624002410409702,14.871687492675882,29.551937832348468,30.664178965664888,16.213692959756962,26.606075339783196,31.1840175169274,12.269116483089237,33.251291095739454,28.73762977164019,34.67624907967325,7.080863206624745,7.5409960281453685,19.035834855449853,14.375942262069408,31.431697592720745,25.52959526000457,22.124991656557714,20.115042958146166,21.88614372357889,19.022194949642998,27.36547256649117,24.22999163953847,43.52048975066457,25.093876817215495,22.83631854654395,18.392334858241778,9.08295495787869,21.37413484386242,21.70602127486682,36.6634160346891,31.774063338174678,33.37115746969715,22.90312150443024,23.047143507197074,16.194052810156457,13.901042809898193,24.358246503844416,22.29483423276484,22.355212026768676,29.438356919533362,24.47836703923699,25.01332399832282,29.923262374418147,23.847825851894207,33.317743588536416,33.241984817738214,28.43451951462648,30.974768526625184,35.10581054150829,42.64465495756754,28.894316779250726,29.1700650338124,22.471866860662523,26.816032450276207,27.765465756750256,22.781576761957663,19.77661000120407,22.34283760626545,8.880200205130802,39.40052577720709,18.070828776399686,23.95598020851328,15.266329274276375,20.58546806761617,28.33040970279655,33.987906750168335,19.605318350234132,32.61311332790419,36.18391555875971,11.771359855202128,25.0863275180885,21.18309502607494,16.46182258098893,8.63004939137905,19.32040120641218,26.60502994164767,21.427069565623857,30.198776242822525,14.933646726007376,29.06394537134811,27.31668505948592,22.514225071672936,17.60460412453374,23.440766448912573,26.89359000285304,32.20593049868189,15.613570360753133,20.25066767905231,24.91745652642056,17.854985512196535,31.52845671540779,-0.2872816930750872,14.79988481303734,20.64926663179736,27.845342305690373,23.578936767971094,19.617763167947672,12.261365759391815,21.64832709478473,27.8840203795694,23.3304828316589,20.31449634629874,23.562795386129235,22.935351378013742,19.24104324449435,15.257634048467569,13.73800284842487,32.76117270430374,20.776770783094744,14.322016350630639,14.410386388931782,32.952940830003946,35.06405474611191,35.987129551104246,26.019892554978895,18.824435141024757,21.399883443065633,26.117657665646043,24.381157595236708,18.860666175790335,14.9864759412194,23.889067861613142,21.99382536800994,29.46725644522179,20.85387818078784,17.676022324249676,27.29985552734908,21.124258020115978,17.489117525553365,14.749488781824086,30.62909466768877,26.430444830722426,45.16302882246396,26.61587398622069,25.61740656307481,30.25846496894762,21.955796554711636,27.848324397051613,20.591810280619963,32.074265847943394,22.78246737668628,29.06286370557906,31.580568107661712,20.602817981359816,20.233387917075376,28.2377565461095,24.048548041786542,40.26282079416538,36.62266756833965,36.97830900052641,27.918443016403003,21.943091014946063,35.71629095462228,33.930138502690916,17.72792283139637,36.66878212153997,12.800570103995907,26.608422301774198,34.411513779346166,14.838356901579159,29.6102510819749,2.40496682182431,17.147174586722866,28.75915384716915,23.773523838173936,23.31950555194003,5.690750344350889,28.57890932409631,26.68451489553683,25.267802758570312,26.00130177961434,19.18697111632097,22.432316967409236,26.245052000217537,26.085023568496965,36.006022002889566,44.99514553077734,19.793681254793484,30.900105180917848,29.655169162053426,14.425809237319173,30.12819528994517,25.505377147275034,33.891590046880296,30.33511058864771,19.134096984116425,18.687037389376925,33.393396765830246,10.218279391089197,36.22042264769793,15.96067001526151,21.87815774719019,17.444325423735922,19.94336338745763,18.08598839541729,6.784921416196557,21.226574807579993,16.22969039519758,20.174942861349706,21.525393653960084,36.730429560475,20.69411768579307,31.03374239495288,39.37381829360253,16.254124111284575,24.60224264034239,29.685235064283038,34.16862911884833,22.82642055631623,21.305073960467332,24.0002635799746,31.124444478740777,41.174464714958084,23.680011208282377,24.429805563933446,7.683989715988394,27.5560768759406,29.295764958000184,27.191966474083323,20.82354350311552,29.25232959424961,17.321378480388503,13.049881881765325,32.66209491034825,13.216800440341286,17.44622121720497,24.398886355409164,29.480254510439355,18.945828574071584,26.030687402506633,31.09111748381505,27.997936334055048,21.124234950211388,32.12437573049928,26.407014841627184,31.668061630958285,33.409769315597806,26.479494713754555,29.59268984501824,27.09702336654668,36.06846961990271,23.445552103294936,21.09530170317362,30.373855310523183,23.24141959861238,29.629567562753437,25.17940940569524,2.107934175283443,27.841310499621667,36.16073968740026,25.604840039751146,20.148568264612457,24.549639866683403,28.68787850863044,26.770712666020327,39.85119174309512,26.893964475854666,21.38704515241523,14.547586133653509,-3.4520029708092537,25.263415048697638,15.982561799468968,16.803051543228335,24.47875162124308,29.131092725731925,25.222358164526252,11.83286580261101,25.419840480827844,25.90138146599332,21.801267680428005,28.7205696637965,14.573761925360222,9.858163709310128,16.632358094918793,24.172547376817235,33.326987067756306,10.601482730795809,18.62764553453971,24.03911381308688,20.95299612834302,19.173410672308783,24.98171035488954,15.153390456020214,25.579403335265766,24.70056749986433,11.195703581646917,33.83575028988785,22.60572188823173,14.788266734886609,23.211816885391414,19.66651326929434,28.950818743550194,24.74426239231331,23.155168867865815,21.04760874359094,20.692105251876324,23.0163061434263,23.765743301499235,27.793049598379984,17.94083177982506,26.196192159977926,30.113705672030264,26.514177362702387,22.31223539398752,20.52779411851172,7.0014412626330245,4.076871365030211,22.96936358169846,23.988576623054982,19.65841357394524,18.564984169251886,23.60273295087801,22.798729039797735,5.581459613699762,28.387267376241837,9.750576306827664,23.405668709816588,12.149343799130254,17.790406775140944,38.13130994551916,23.180067005493836,21.901315450536654,12.65868614378774,12.018185721254147,12.366538601844844,21.341850750015787,34.56345974624782,28.942570930460608,10.749813127263414,22.126125724838367,-10.898544622339648,18.081684696653323,20.192521369325988,28.199737236654336,17.12003193989164,21.326806527085907,12.997662075030258,1.1179166046170312,4.768968020119814,14.221548692901557,19.981255488026495,19.052916835199408,18.36314185287361,15.019268742944227,30.68574194569532,21.20744165282054,11.632014844217206,10.8768671407997,3.816864572957423,23.25882608629726,21.95949854908448,25.91385650396408,27.21532711124237,6.714274109277039,5.549788697779229,-15.20642276122656,14.531727923362018,10.817219171082666,12.421931235609328,23.631797905962923,3.06581820567014,15.04662445189561,16.225995128722275,5.6550158040370775,5.307286142126389,12.834358176426694,21.563985376040623,12.717090740544409,-1.2745772324555826,19.79947167918735,25.291640617084404,21.971479242443728,4.911302611541725,16.60281958463505,24.63202921241014,20.42080881342294,20.562063211904757,3.723713860267984,19.902287771941374,29.80257103659411,13.468091841862574,25.980116364309218,15.334117970699005,22.37736370383885,14.616043925861751,21.310100675424025,21.532808772344875,19.381765844424706,14.969270936238502,11.392379374243026,5.708347769818754,29.040873056518073,24.543637100095754,24.732038628130113,20.15318717201813,22.22377254031198,17.675849570366722,22.719812444948797,17.7215803032733,22.02593464415063,23.01810167554404,12.644077452286469,26.42434364245065,36.80484293332502,18.352233791699856,25.083715827686724,37.64667100263465,16.511005528408703,23.121671789512035,12.71236632496413,11.92099846602398,15.689937640678162,8.668335457426618,19.4506902850883,13.178196301855245,21.372525868946592,21.322029039834536,15.626602749193113,10.57841059700122,20.844359763583505,22.579861685051323,22.4778674706235,17.476274907027307,39.72654299659574,15.232186145617979,28.426684744682618,23.202486028697322,10.834273673972735,26.773809249611627,23.83569499329012,22.404206161651075,20.838444671623687,18.921087001083052,12.728480624387046,26.976932532977315,17.817721652469725,32.279716722119446,20.069626946764778,17.99694661609709,22.254432252822948,22.89046984979346,25.724936566072593,17.43147621867405,17.054242183170167,21.280824773222765,8.489170213071462,25.43951320584258,20.845435074558285,27.62114114174537,18.23340246848162,10.618732111964889,37.144422759079376,26.334844488320883,33.600482412343716,20.931447337964215,22.856290516470352]}],{"yaxis":{"title":"Median Value"},"xaxis":{"title":"Rooms"}}, {displayModeBar: false});</script>
<p>This simulation facility can be used for a common operation in model criticism: calculating residuals. Often, residuals are
calculated by averaging the posterior parameters (or using a point estimate), making a single prediction and subtracting this
from the observed outcome. Here, we argue that this is incorrect. From a Bayesian point of view, it almost never makes sense
to average the parameters. Instead, the parameters, the predicted outcome and the residuals themselves are all probability
distributions. In order to achieve something plottable, we average the predicted outcome over all the Markov chain Monte Carlo
samples and subtract this average prediction from the observed outcome. This has the advantage that in case of banana-shaped or
multimodal posteriors (arising, for instance from lack of identifiability) the average prediction is more meaningful than
the prediction with the average parameter value.</p>
<pre class="haskell"><code>let simEnvs = runSimulate 100 linRegression resEnv

    avgYs = avgVar simEnvs &quot;y&quot;    -- the average prediction

    residuals = zip (unPairDoubles $ fromJust $ Map.lookup &quot;x&quot; sdata)
                    $ zipWith (-) (unDoubles $ fromJust $ Map.lookup &quot;y&quot; sdata)
                                  (unDoubles avgYs)
</code></pre>
<div id="bhres"></div><script>Plotly.newPlot('bhres', [{"mode":"markers","x":[6.575,6.421,7.185,6.998,7.147,6.43,6.012,6.172,5.631,6.004,6.377,6.009,5.889,5.949,6.096,5.834,5.935,5.99,5.456,5.727,5.57,5.965,6.142,5.813,5.924,5.599,5.813,6.047,6.495,6.674,5.713,6.072,5.95,5.701,6.096,5.933,5.841,5.85,5.966,6.595,7.024,6.77,6.169,6.211,6.069,5.682,5.786,6.03,5.399,5.602,5.963,6.115,6.511,5.998,5.888,7.249,6.383,6.816,6.145,5.927,5.741,5.966,6.456,6.762,7.104,6.29,5.787,5.878,5.594,5.885,6.417,5.961,6.065,6.245,6.273,6.286,6.279,6.14,6.232,5.874,6.727,6.619,6.302,6.167,6.389,6.63,6.015,6.121,7.007,7.079,6.417,6.405,6.442,6.211,6.249,6.625,6.163,8.069,7.82,7.416,6.727,6.781,6.405,6.137,6.167,5.851,5.836,6.127,6.474,6.229,6.195,6.715,5.913,6.092,6.254,5.928,6.176,6.021,5.872,5.731,5.87,6.004,5.961,5.856,5.879,5.986,5.613,5.693,6.431,5.637,6.458,6.326,6.372,5.822,5.757,6.335,5.942,6.454,5.857,6.151,6.174,5.019,5.403,5.468,4.903,6.13,5.628,4.926,5.186,5.597,6.122,5.404,5.012,5.709,6.129,6.152,5.272,6.943,6.066,6.51,6.25,7.489,7.802,8.375,5.854,6.101,7.929,5.877,6.319,6.402,5.875,5.88,5.572,6.416,5.859,6.546,6.02,6.315,6.86,6.98,7.765,6.144,7.155,6.563,5.604,6.153,7.831,6.782,6.556,7.185,6.951,6.739,7.178,6.8,6.604,7.875,7.287,7.107,7.274,6.975,7.135,6.162,7.61,7.853,8.034,5.891,6.326,5.783,6.064,5.344,5.96,5.404,5.807,6.375,5.412,6.182,5.888,6.642,5.951,6.373,6.951,6.164,6.879,6.618,8.266,8.725,8.04,7.163,7.686,6.552,5.981,7.412,8.337,8.247,6.726,6.086,6.631,7.358,6.481,6.606,6.897,6.095,6.358,6.393,5.593,5.605,6.108,6.226,6.433,6.718,6.487,6.438,6.957,8.259,6.108,5.876,7.454,8.704,7.333,6.842,7.203,7.52,8.398,7.327,7.206,5.56,7.014,8.297,7.47,5.92,5.856,6.24,6.538,7.691,6.758,6.854,7.267,6.826,6.482,6.812,7.82,6.968,7.645,7.923,7.088,6.453,6.23,6.209,6.315,6.565,6.861,7.148,6.63,6.127,6.009,6.678,6.549,5.79,6.345,7.041,6.871,6.59,6.495,6.982,7.236,6.616,7.42,6.849,6.635,5.972,4.973,6.122,6.023,6.266,6.567,5.705,5.914,5.782,6.382,6.113,6.426,6.376,6.041,5.708,6.415,6.431,6.312,6.083,5.868,6.333,6.144,5.706,6.031,6.316,6.31,6.037,5.869,5.895,6.059,5.985,5.968,7.241,6.54,6.696,6.874,6.014,5.898,6.516,6.635,6.939,6.49,6.579,5.884,6.728,5.663,5.936,6.212,6.395,6.127,6.112,6.398,6.251,5.362,5.803,8.78,3.561,4.963,3.863,4.97,6.683,7.016,6.216,5.875,4.906,4.138,7.313,6.649,6.794,6.38,6.223,6.968,6.545,5.536,5.52,4.368,5.277,4.652,5,4.88,5.39,5.713,6.051,5.036,6.193,5.887,6.471,6.405,5.747,5.453,5.852,5.987,6.343,6.404,5.349,5.531,5.683,4.138,5.608,5.617,6.852,5.757,6.657,4.628,5.155,4.519,6.434,6.782,5.304,5.957,6.824,6.411,6.006,5.648,6.103,5.565,5.896,5.837,6.202,6.193,6.38,6.348,6.833,6.425,6.436,6.208,6.629,6.461,6.152,5.935,5.627,5.818,6.406,6.219,6.485,5.854,6.459,6.341,6.251,6.185,6.417,6.749,6.655,6.297,7.393,6.728,6.525,5.976,5.936,6.301,6.081,6.701,6.376,6.317,6.513,6.209,5.759,5.952,6.003,5.926,5.713,6.167,6.229,6.437,6.98,5.427,6.162,6.484,5.304,6.185,6.229,6.242,6.75,7.061,5.762,5.871,6.312,6.114,5.905,5.454,5.414,5.093,5.983,5.983,5.707,5.926,5.67,5.39,5.794,6.019,5.569,6.027,6.593,6.12,6.976,6.794,6.03],"type":"scatter","y":[0.1801445055689861,-3.6051030762980965,8.298694533192677,7.094416126926319,8.317427416507076,3.8541408442455065,0.4715361636313098,3.685235479272297,-4.448057350534722,-5.5877889776758245,-9.187208953589412,-4.241920264885795,-0.9431785651941453,-2.927875232209878,-5.012999636561595,-2.8479834997147933,1.4949349507833354,-4.9868694483757885,-0.22832084295433575,-3.94628537814825,-6.957001323177073,-2.5768607639164784,-7.453397703852644,-6.241653064234434,-6.517350642290337,-7.2809275612993485,-5.448076368315878,-7.315219452074867,-5.841274380897058,-4.212085502688247,-7.9426786964142515,-7.117124161792937,-8.858527621305022,-7.708256036311566,-7.766451622371509,-4.343297867963475,-2.950416706614302,-1.1213094037390654,1.4704450394057105,5.683158791408587,8.58264906666055,-0.283542171018734,1.7521765034207242,0.8614458389723865,-2.1449945290735855,-2.6139622531634537,-2.4060027045456387,-6.667102587611787,-6.566293244250479,-1.3263615111662581,-2.6573666684667323,-2.9176147105932024,-7.447519705820937e-2,0.5357111348404437,-2.1816870204431673,7.6803652380916745,-0.6321631247198702,5.19405587811271,0.11717549809134198,-4.56964241745899,-2.674519186712132,-6.605334317868632,-2.478612284426127,0.6603044839706449,6.760131379640306,-1.1379898814725777,-2.7555443772185377,0.20257686520160334,-3.477245895961026,-2.5944231322901423,-0.19124119060068523,-2.470702602902705,-0.7266382371919242,1.0796652503642576,-0.4949124112933241,-2.50483031506187,-5.118711592887166,-2.6984868219283946,-1.9205813571170083,-1.6167342164972567,1.5240847464026146,-1.8958170521543352,0.28411025556690106,-1.273813003142962,-1.2949001000463447,0.4390337367144781,-0.6387577794705521,-1.6111167299366294,-3.5593711823918213,1.3247729705746423,-2.0848382962415464,-2.4414316313133035,-2.425136544074604,0.85040750146797,-3.704711619071144,2.597588688049644,-3.2232735170552367,7.064618784364281,12.865158478362833,4.391496946198114,2.1588990916805813,1.1265463807625835,-5.550372022528816,-3.495502807570009,-2.9470606271703055,-1.9859930448564107,-2.9429694970028493,-2.6818519281137227,-5.278056273795549,-3.69522413896145,-2.188137962139738,-2.2139431468774653,-4.026701099720043,-4.305630297620361,-5.508412829264589,-4.4802637344442005,-2.836751761515508,-4.2764043782739485,-3.057918159644103,-2.5249766330518817,-0.48224729090116725,-1.9588872533642139,-1.481801188303713,-4.560130725459707,-2.803005863832805,5.938475773850982e-2,-5.138948016976048,-5.063576091264196,-6.796859212703925,-6.922749422706474,-5.39654398785083,-5.986196552345191,-2.4489495416760967,-4.658195339365253,-6.8076456674051276,-6.270071029637975,-4.896141020265311,-6.613513322123609,-9.131318244503571,-5.501553495710887,-9.759458829892385,-3.627033099574634,-6.5046228032927385,-4.593886614624905,-6.0124964001509085,-8.936630554226404,-5.764768406175913,-3.4082216038117448,5.465929361778166e-2,-4.176352429799637,-0.8509221353417615,-0.8110263545318901,-4.569307901771591,-1.1971458149039087,-6.0900900263457665,-5.874869304533037,-6.07594234698311,13.818447957530157,0.9848334774517014,-1.4415933437611272e-2,3.9582845116601213,22.185040046758967,20.35365727923246,17.916820895167376,0.48163533189246976,2.425889619548691,20.262967919510718,2.2563921275055563,-0.13361556277272513,-1.2277114963814668,-4.428560704809271,-1.6237144610842407,2.483708959604769,-2.5795409525153907,0.34265600692365084,3.368940508618831,-0.7325332318175839,0.7741389418214517,3.236878658721377,9.32568016739975,10.080761443694701,11.978277020585622,10.10907183083987,7.610615021642229,5.712047865761516,5.451080780855154,20.422562580639223,5.678159975754674,5.2375359686386,6.559954949526809,9.397792909873683,4.541000009932098,9.336169452146827,3.639547978498012,2.670058211329305,20.123253388343496,3.381732234445419,2.736800372551052,7.33417791349661,8.37042502368427,6.5568315781173645,0.35037420729378255,13.581549183952962,17.64079309141268,19.734177549437945,-0.19019460799310295,0.3809678935310572,0.20375526421273094,1.5875430024522004,-0.46340497716184714,-0.4401512649507566,-2.694305059517472,0.35602610570805027,3.360089889906728,3.318664054020484,2.050753629424122,0.3830852268694933,2.9757826744608558,0.5864836830722915,-1.2455221775617282,-1.0182397861295343,-2.0935294411878793,0.16859423607081325,3.4446731690744983,13.38804813232893,17.317126828265906,7.237628882225909,5.0891544052343605,18.704359527776592,6.9733966852611715,1.1722303247104868,5.5203767142631115,9.783911045219511,15.772790247331983,2.553812610002531,0.3290525991402262,0.313779055888336,2.849400661223722,-1.2455371312350572,-3.1564789304475482,-3.160869044540952,-2.628988245005651,-2.0369756612247585,-0.3325143411194311,-3.841484847219398,-2.979602381145124,0.5111290338294339,-3.782877526903082,0.5158531835259375,1.4715932035668438,0.26626641336291357,0.9438340387956927,3.5751691851253113,12.239359728110099,8.013418825429852e-2,-0.8150653154124825,15.484552242797225,15.959815793510217,8.337678816103278,3.5137507629976383,7.0713311459595545,13.638350261238187,17.812563910065805,3.6473888567256836,8.006382643193358,2.3272368706543496,3.4984997236184228,17.618888183237083,14.615517651165813,-1.4103400014027478,-2.0642694545885725,2.18250653136365,-0.8896493239662036,6.32771973957659,6.725556708520678,5.5121718352035565,4.293172395757157,6.089829005969452,6.041210803048603,9.470508990331219,13.853484686456344,9.003333232546712,16.470803232650468,19.15755297739702,4.490033314880371,-3.5258939367591893,-3.727126348409346,-1.5151865235847808,-1.8797332419931934,0.503181589795922,2.758311696203041,9.757845469829338,3.112335239889404,0.5844195517131645,-0.8515441484525823,2.4392161753855,1.4148824147664492,-1.0160948207751552,-1.7956466902968273,1.0492680950489337,-0.7162239431396529,-3.250234413411782,1.2684014866068196,6.427459735234066,8.111418542448728,2.8412300819336984,4.166701413847775,2.0856145369042522,-2.0390741664118934,-1.8687769262668397,-2.071910369356072,-0.8874610449868783,-4.391394481278947,-2.3794768160234305,-0.8506961884332398,-5.649847383875041,-4.1279055985020605,-2.2639070969727513,-0.7722704617858511,-3.633589676573205,-0.8053964244099951,-0.9128048337193313,-2.2187397105756936,-3.676236122025344,-0.3755940085654714,-5.231568956936172e-2,-1.2786207538986858,-0.5251744909390226,-2.577802445935312,-1.5784022586887545,-3.2337938036644758,-4.876106358656919,-2.7670498373432935,-1.884046438328152,-5.7337595101189756,-1.3005874652893894,-2.463202744914817,-3.731389953482875,-2.397609173160557,-3.8689236137651903,-3.727411868520587,4.495292216863778,-9.14843403298071,-1.534569720050591,4.2695764883763125,-5.854516423956817,-6.018491481735214,-1.655145655667365,-0.5612475873070295,-1.0199812204171792,-2.4407677364939886,-1.571632082034096,-4.333343939386214,4.131779542084924,-4.361248714018455,-1.7639363101125447,-2.1546862528660284,-1.2337124293030044,0.9230690112609814,0.38269930383607687,2.245586129743007,-2.2785756839613036,1.5667724663604332,-4.530804445746231,-10.333422465974358,14.778057861175052,3.125477854550315,12.672143488994669,32.222558003383824,27.04670134595914,24.971313219834347,28.417117936764626,30.857813081325265,-1.9083847717886897,4.791087822202668,-5.800124189767288,-6.24309037036368,-9.754894862027058,-3.22795149660446,-7.029422003049508,15.640529503475491,-8.578385738431917,-7.117631095410221,-4.681158313984287,-0.5520546609314909,-9.083071323031412,1.249864789340485,-3.2660886725218603,-3.480540306972575,-6.154947842740981,-3.7223097756764556,1.7826380441719536,-5.877449222269892,-6.060755431233581,-5.584958428675748,-9.25363053014422,-10.307572234002233,-10.194608714031453,-3.1332875597549865,-11.718185643709035,-8.620240721816101,-11.686794545667311,-9.019150933287554,-4.760132243977653,2.932669273308634,7.222283731978598,2.9293755744396215,10.384273993926197,-5.818553879323929e-2,6.100951966617718,11.681279849253524,-4.016522244658269,6.452720864620753,6.384670439338835,5.6878704496530705,-11.591722088424998,-15.60863528530028,-0.1947265567207559,12.608747746949014,-13.701276375275265,-3.906206808224809,-6.631238965695303,3.120535809765496,-7.7317772950388655,-6.373476093777974,-8.059614598355374,-6.78962405659966,0.2736062713423433,-9.435389516419576,-12.312043073619307,-7.680732668524474,-8.712755294122863,-6.133121938400485,-7.5650907993723635,-8.198766006755253,-8.482423093446736,-9.418818118075782,-9.826789502099444,-8.229997512263543,-3.946269424773064,-3.9602093701445895,-3.953821782814469,-3.8577770359412007,-8.150732756463805,-6.344492804494077,-10.258481218516753,-8.174406868067196,-7.7334396199683635,-5.530687984337169,-8.496422845979389,-9.023981081997421,-8.936827305751574,-7.427656497047888,-7.801561755749191,-7.2074932058461325,-9.794974468166322,-8.35715848007371,-6.499855305720054,-6.388012272935979,-0.25767304671405,-6.825706275245697,-4.772372739261218,-1.9712711450346845,-2.603616184549992,0.3026268495289628,-1.542035936108448,-2.0380927480279496,-2.7395688825309428,1.626628760589199,2.8874567693095123,-3.388266737848479,-2.9018207035921755,-0.5367054464508492,4.304519868713289,-4.47610464098593,-7.520741178216213,-6.76997222949894,-4.400609988931233,-5.009205347822666,2.6088473692089735,0.6557456032986337,-0.4809075030733041,-0.2897172637599681,1.1670706195770606,-1.1564752421071027,-1.176012666842933,-2.450044248675624,-9.454358560017084e-3,-5.968478922565257,-13.512539287326469,-11.934212114939443,-9.19163302899562,-2.2295389065535893,-0.22146957829829717,1.194522070293278,-5.467049211416253e-2,-0.9640477241295002,-4.184939023478417,-1.640315238828613,-4.280458624699953,-6.24944782788581,-2.93709558896359,-3.415895883314878,-2.1542681824904193,-5.107791948953118,-11.92463782587008]}],{"yaxis":{"title":"Median Value Residual"},"xaxis":{"title":"Rooms"}}, {displayModeBar: false});</script>
<h2>Discussion</h2>
<p>We have shown prototype bindings to Stan in the Haskell language. Unlike other such bindings, our model definition is a data
type in the host language. This enables us to simulate from the model with fine control over the model parameters which may
come from a posterior following inference.</p>
<p>Simulation with fine control over the provenance of the parameter distribution has several advantages. We have already shown
how it can be used to define the residuals and how to simulate from the posterior predictive distribution. In many cases, such
an instruction to simulate from the posterior predictive distribution will be incompletely specified. For instance, if we are
dealing with a hierarchical regression model, should the posterior predictive distribution retain the group identities? One
posterior predictive simulation would have entirely new groups, while another could have new individuals but drawn from groups
that are specified from the data.</p>
<h3>Further work</h3>
<p>The Haskell interface to Stan we have shown here is an incomplete prototype. The model definition language can be polished
to reduce the amount of syntactic noise. Ideally, we would also have the ability to parse models written in the standard Stan
language. We can also make it much easier to move data into Stan, and to parse data from the posterior samples and from the
simulation environment. This will be facilitated when the Haskell data science community converges on one of the several
proposed implementations of data frames.</p>
<p>Representing a Stan model in a data structure opens other possibilities. We plan to implement a function to combine two different
models by specifying a list of the parameters that are common in the two models. Thus, two different manifestations of the same
underlying constants can be investigated independently before the evidence is combined.</p>
<h2>About this document</h2>
<p>The code for this document is <a href="https://github.com/glutamate/stancon">hosted on GitHub</a>. It is written using the <a href="https://github.com/diffusionkinetics/open/tree/master/inliterate">inliterate
notebook format</a> which allows a mixture of code, text
writing, and the result of running code. Compared to Jupyter notebooks,
it is less interactive (there is no caching) and it emphasises a cleaner, human- readable source format that can be checked
into version control. Plots are generated with Plotly.js.</p>
<h2>References</h2>
<p>Lennart Augustsson, Howard Mansell, and Ganesh Sittampalam. Paradise: a
two-stage DSL embedded in Haskell. In ICFP &#39;08: Proceeding of the 13th
ACM SIG-PLAN international conference on Functional programming, pages 225-228, New York, NY, USA, 2008. ACM.</p>
<p>George Giorgidze and Henrik Nilsson. Mixed-level Embedding and JIT Compilation for an Iteratively Staged DSL. In Julio Mariño, editor, Proceedings of the 19th
Workshop on Functional and (Constraint) Logic Programming (WFLP 2010), volume 6559 of Lecture Notes in Computer Science, pages 48–65, Springer-Verlag, 2011.</p>
<p>Geoffrey Mainland. 2007. Why it&#39;s nice to be quoted: quasiquoting for haskell. In Proceedings of the ACM SIGPLAN workshop on Haskell workshop (Haskell &#39;07).
ACM, New York, NY, USA, 73-82.</p>
<p>J. Svenningsson and E. Axelsson. Combining deep and
shallow embedding for EDSL. In Trends in Functional
Programming (TFP) 2012, Revised Selected Papers,
volume 7829 of Lecture Notes in Computer Science,
pages 21–36, 2013.</p>
<p>Peter Thiemann, Programmable Type Systems for Domain Specific Languages,
Electronic Notes in Theoretical Computer Science, Volume 76, 2002,
Pages 233-251, ISSN 1571-0661.</p>
</div></div></div></body></html>
